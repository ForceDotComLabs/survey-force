<apex:page standardcontroller="Survey__c" title="Survey" extensions="SurveyAndQuestionController" cache="false" sidebar="false" showheader="false" lightningStylesheets="true">
	<apex:includeScript value="{!$Resource.SurveyForce + '/SurveyForce_jquery.js'}" />
	<apex:includeScript value="{!$Resource.SurveyForce + '/jquery-ui.min.js'}" />
	<apex:stylesheet value="{!$Resource.SurveyForce + '/jquery-ui.min.css'}" />

    <!-- convertCheckBoxToLDS() is in surveyforce.js -->
    <apex:includeScript value="{!$Resource.SurveyForce + '/surveyforce.js'}" />
    <apex:stylesheet value="{!$Resource.SurveyForce + '/surveyforce.css'}" />
	<apex:slds/>
    <script>
        $(document).keyup(function(e) {
            //Close modal dialog on escape
            if (e.keyCode === 27) { // escape key maps to keycode `27`
                closeDialog('addQuestion');
            }
        });
    </script>

    <script type="text/javascript">
        function confirmDelete(deleteId) {

            var r = confirm($Label.LABS_SF_Confirm_Delete);
            if (r) {
                return true;
            } else {
                return false;
            }
            /**/
        }

        $(document).ready(function() {

            $("#justQuestionList").sortable({
                axis: 'y',
                opacity: .6,
                tolerance: 'pointer',
                revert: true,
                update: function(event, ui) {
                    var childIds = new Array();
                    var cIds = "";

                    $('#justQuestionList .question').each(function () {
                        cIds = cIds + $(this).attr('id') + ",";
                    });

                    $("input[id*='newOrderList']").val(cIds);
                    $("a[id*='saveOrder']").effect("pulsate", {
                        times: 2
                    }, 1000);
                }

            });
        });

    </script>
    <div class="slds-scope">
		<apex:form >
			<c:uiMessage severity="{!pageMessage.severity}" message="{!pageMessage.message}" renderMe="{!pageMessage.isMessage}" />
			<div class="slds-box slds-theme_shade">
				<div id="navBarBg"></div>
				<apex:outputPanel id="navBar">
					<apex:commandLink styleclass="slds-button slds-button_brand" onclick="addQuestionLoad(); openDialog('addQuestion');" action="{!makeNewQuestionLink}" value="{!$Label.LABS_SF_AddQuestion}" reRender=" addQuestionContent " />
					<apex:commandLink styleclass="slds-button slds-button_brand" id="saveOrder2" action="{!updateOrderList}" value="{!$Label.LABS_SF_SaveOrder}" />
					<apex:inputHidden id="newOrderList" value="{!newOrderW}" />
				</apex:outputPanel>
			</div>

			<!-- addQuestion starts -->
			<div id="addQuestion" role="dialog" tabindex="-1" aria-labelledby="header43" class="slds-modal slds-fade-in-hide">
				<div class="slds-modal__container">
					<div class="slds-modal__header">
						<button class="slds-button slds-modal__close slds-button_icon-inverse" onclick="closeDialog('addQuestion');return false;">
							<apex:image url="/img/icon/t4v35/action/close_60.png"  />
							<span class="slds-assistive-text">Close</span>
						</button>

						<!--
							have to use actionRegion because some fields below have required=true.
							And when form is submitted, it fails with the validation error and doesn't refresh questions.
						-->

						<apex:actionRegion >
							<apex:actionFunction name="addQuestionLoad" action="{!setupQuestionFields}"  reRender="addQuestionContent"/>

							<apex:outputPanel id="selectQuestionType">
								<div class="slds-form-element">
									<label class="slds-form-element__label">{!$Label.LABS_SF_SelectQuestionType}</label>
									<div id="topPickList">
										<apex:selectList styleClass="slds-select" size="1" value="{!questionType}" id="questionSelect" onChange="addQuestionLoad();">
											<apex:selectOptions value="{!questionTypeOptions}" />
										</apex:selectList>
									</div>
								</div>
							</apex:outputPanel>
						</apex:actionRegion>
					</div>
					<div class="slds-modal__content slds-p-around_medium">
						<apex:outputPanel id="addQuestionContent">
						<!-- Single Select Question -->
							<apex:outputPanel id="singleSelect" rendered="{!showSingleSelect || showMultiSelect || showRowQuestion || showFreeText}">
								<div class="slds-form-element">
									<label class="slds-form-element__label">{!$Label.LABS_SF_Question}</label>
									<apex:inputTextArea styleClass="slds-textarea" cols="30" rows="3" id="qQuestion" value="{!qQuestion}" required="true" title="The question you would like asked" />
								</div>
								<div class="slds-form-element__control" title="{$ObjectType.Survey_Question__c.fields.Required__c.inlineHelpText}">
									<label class="slds-checkbox">
										<apex:inputCheckbox value="{!qRequired}" selected="{!qRequired}"/>
										<span class="slds-checkbox_faux"></span>
										<span class="slds-form-element__label">{!$Label.LABS_SF_RequiredQuestion}</span>
									</label>
								</div>
								<apex:outputPanel rendered="{!showSingleSelect || showMultiSelect || showRowQuestion}">
									<div class="slds-form-element">
										<label class="slds-form-element__label" for="qChoices">{!$Label.LABS_SF_PleaseEnterTheList}</label>
										<div class="slds-form-element__control">
											<apex:inputTextArea styleClass="slds-textarea"  cols="40" rows="3" id="qChoices" value="{!qChoices}" required="true" title="Answers to question..." />
										</div>
									</div>
								</apex:outputPanel>

								<div class="slds-modal__footer">
									<apex:commandButton styleClass="slds-button slds-button_brand" action="{!controllerSavQuestion}" value="{!$Label.LABS_SF_Save}" />
									<button class="slds-button slds-button_brand" onClick="closeDialog('addQuestion');return false;">
											{!$Label.LABS_SF_Cancel}
									</button>
								</div>
							</apex:outputPanel>

						</apex:outputPanel>

					</div>
				</div>
			</div>
			<div id="addQuestionBackdrop" class="slds-backdrop slds-backdrop_hide"></div>
			<!-- End addQuestion -->

			<div id="questionList">

				<apex:outputPanel id="qListPanel">
					<div id="justQuestionList">
						<apex:repeat value="{!aQuestion}" var="q" id="qRepeat">
							<div class="slds-box slds-theme_default">
								<div id="{!q.id}" class="question" title="Drag and Drop to Reorder">
									<apex:outputPanel >
										<div class="question_menu">
											<apex:image value="{!URLFOR($Resource.SurveyForce, '/icons/survey_upDown.png')}" styleClass="left" />
											<apex:commandLink styleclass="slds-button slds-button_neutral" action="{!editQuestion}" value="Edit" onComplete="openDialog('addQuestion');" reRender="addQuestionContent, addQuestion, selectQuestionType">
												<apex:param name="q" value="{!q.Id}" assignTo="{!questionReference}" />
											</apex:commandLink>
											<apex:commandLink styleclass="slds-button slds-button_brand" action="{!deleteRefresh}" value="Delete" onclick="return confirmDelete('{!q.id}')">
												<apex:param name="q" value="{!q.Id}" assignTo="{!questionReference}" />
											</apex:commandLink>
										</div>
										<br />
										<div class="slds-text-heading_medium">
											<apex:outputText escape="true" value="{!q.orderNumber + ':'}"/>
											&nbsp;<apex:outputText escape="true" value="{!q.Name}"/>
											&nbsp;<apex:outputText rendered="{!q.required}" styleClass="slds-text-color_error slds-text-body_regular" value="({!$Label.LABS_SF_Required})"/>
										</div>
										<div>
											<apex:selectRadio layout="pageDirection" rendered="{!q.renderSelectRadio}">
												<apex:selectOptions value="{!q.singleOptions}"  />
											</apex:selectRadio>
											<apex:selectCheckboxes layout="pageDirection" rendered="{!q.renderSelectCheckboxes}">
												<apex:selectOptions value="{!q.multiOptions}" />
											</apex:selectCheckboxes>
											<apex:inputTextArea styleClass="slds-textarea" cols="50" rows="{!q.noOfRowsForTextArea}" rendered="{!q.renderFreeText}" />
											<apex:selectRadio rendered="{!q.renderSelectRow}">
												<apex:selectOptions value="{!q.rowOptions}" />
											</apex:selectRadio>
										</div>
									</apex:outputPanel>
								</div>
							</div>
						</apex:repeat>
					</div>
				</apex:outputPanel>
			</div>
		</apex:form>
		<apex:outputField rendered="false" value="{!Survey__c.Thank_You_Text__c}" />
    </div>
</apex:page>